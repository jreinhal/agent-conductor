name: CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # ── Lint & Build ─────────────────────────────────────────────────
  lint-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238  # v6.2.0
        with:
          node-version: "20"
          cache: "npm"

      - name: Scan for secrets (gitleaks)
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7  # v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

      - name: Start app server for quality gates
        run: |
          npm run dev > /tmp/agent-conductor-dev.log 2>&1 &
          echo "DEV_SERVER_PID=$!" >> $GITHUB_ENV
          npx wait-on http://127.0.0.1:3000

      - name: Handoff freshness gate
        env:
          HANDOFF_DOC_PATH: README.md
        run: npm run check:handoff-freshness -- --refresh true --maxAge 120

      - name: Detect local CLI availability for quality gate
        id: quality_gate_prereq
        run: |
          missing=0
          for cli in codex claude gemini; do
            if ! command -v "$cli" >/dev/null 2>&1; then
              echo "::notice::Skipping quality response gate; missing CLI: $cli"
              missing=1
            fi
          done
          if [ "$missing" -eq 0 ]; then
            echo "run_quality_gate=true" >> "$GITHUB_OUTPUT"
          else
            echo "run_quality_gate=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Quality response gate (>=90%)
        if: steps.quality_gate_prereq.outputs.run_quality_gate == 'true'
        run: npm run eval:quality -- --minPassRate 90

      - name: Stop app server
        if: always()
        run: |
          if [ -n "${DEV_SERVER_PID:-}" ]; then
            kill "$DEV_SERVER_PID" || true
          fi
